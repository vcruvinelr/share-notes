name: CI - Lint, Format, and Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  frontend:
    name: Frontend - Lint, Format & Build
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check TypeScript types
        run: npm run type-check

      - name: Run ESLint
        run: npm run lint

      - name: Check Prettier formatting
        run: npx prettier --check "src/**/*.{ts,tsx,css,json}"

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  backend:
    name: Backend - Lint, Format & Build
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Run Black (format check)
        run: poetry run black --check .

      - name: Run isort (import sorting check)
        run: poetry run isort --check-only .

      - name: Run Flake8 (linting)
        run: poetry run flake8 .

      - name: Run MyPy (type checking)
        run: poetry run mypy app/ --ignore-missing-imports
        continue-on-error: true

      - name: Check Python syntax
        run: poetry run python -m py_compile app/**/*.py

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: always()
    
    steps:
      - name: Check CI Status
        run: |
          if [ "${{ needs.frontend.result }}" != "success" ] || [ "${{ needs.backend.result }}" != "success" ]; then
            echo "❌ CI checks failed"
            echo "Frontend: ${{ needs.frontend.result }}"
            echo "Backend: ${{ needs.backend.result }}"
            exit 1
          else
            echo "✅ All CI checks passed!"
            echo "Frontend: ✅ Passed"
            echo "Backend: ✅ Passed"
          fi
